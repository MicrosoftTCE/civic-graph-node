var ShapeToolboxModule=function(E,D){var h=this;var G=E,w=null,U=null,aa=[],O=[],x=null,Y=[],M=null,ae=null,N=null,u=null,L=null,q=false,t="",j=null,P=null,af=null,d=null,u=null,S=null,k=null,y=null,m=null,R=null,ac=null,f=Microsoft.Maps;var s="1.1";var Q=[];var X={shapeType:"polyline",targetLayer:G.entities,maskStrokeColor:new Microsoft.Maps.Color(200,100,100,100),maskFillColor:new Microsoft.Maps.Color(0,0,0,0),maskStrokeThickness:2,maskStrokeDashArray:"2 2",shapeStrokeColor:new Microsoft.Maps.Color(200,0,0,200),shapeStrokeThickness:2,shapeFillColor:new Microsoft.Maps.Color(100,0,100,0),toolBarPolygonIcon:"images/polygonIcon.png",toolBarPolygonHoverIcon:"images/polygonHoverIcon.png",toolBarPolygonActiveIcon:"images/polygonActiveIcon.png",toolBarPolylineIcon:"images/polylineIcon.png",toolBarPolylineHoverIcon:"images/polylineHoverIcon.png",toolBarPolylineActiveIcon:"images/polylineActiveIcon.png",toolBarPushPinIcon:"images/pushpinIcon.png",toolBarPushPinHoverIcon:"images/pushpinHoverIcon.png",toolBarPushPinActiveIcon:"images/pushpinActiveIcon.png",toolBarPushPinMultiple:true,toolBarRectangleIcon:"images/rectangleIcon.png",toolBarRectangleHoverIcon:"images/rectangleHoverIcon.png",toolbarRectangleActiveIcon:"images/rectangleActiveIcon.png",toolbarCircleIcon:"images/circleIcon.png",toolbarCircleHoverIcon:"images/circleHoverIcon.png",toolbarCircleActiveIcon:"images/circleActiveIcon.png",dragHandleImage:"images/DragHandleWhite.gif",dragHandleImageActive:"images/DragHandleGreen.gif",dragHandleImageHeight:10,dragHandleImageWidth:10,dragHandleImageAnchor:new Microsoft.Maps.Point(5,5),shapeMaskStrokeColor:new Microsoft.Maps.Color(200,100,100,100),shapeMaskFillColor:new Microsoft.Maps.Color(0,0,0,0),shapeMaskStrokeThickness:2,shapeMaskStrokeDashArray:"2 2",shapeMouseCursor:"images/grab.cur",shapeChangedCallback:null};if(D){ab(D)}var v=E.getRootElement(),F=v.offsetParent.id,e=F+"_ToolBarContainer";(function(){var ah=document.createElement("div");ah.id=e;ah.style.top="0px";ah.style.right="0px";ah.style.position="absolute";ah.style.width="140px";ah.style.height="28px";ah.style.backgroundColor="rgb(250, 247, 245)";ah.style.border="1px solid #a0a0a0";ah.style.visibility="hidden";var ag=function(al,ak,aq,ap,ao,an){var am=new Image();am.src=ak;am=new Image();am.src=aq;am=new Image();am.src=ao;var aj='<div id="'+e+'_{0}Button" style="width: 28px; height: 29px; background-image: url({1}); background-repeat: no-repeat; float:left;" onclick="toolBarClick(this, \'{2}\', { shapeType: \'{3}\' });" onmouseover="changeToolBarBackground(this, \'{4}\');" onmouseout="changeToolBarBackground(this, \'{5}\');"></div>';return aj.replace(/\{0\}/g,al).replace(/\{1\}/g,ak).replace(/\{2\}/g,aq).replace(/\{3\}/g,ap).replace(/\{4\}/g,ao).replace(/\{5\}/g,an)};t+=ag("Polyline",X.toolBarPolylineIcon,X.toolBarPolylineActiveIcon,"polyline",X.toolBarPolylineHoverIcon,X.toolBarPolylineIcon);t+=ag("Polygon",X.toolBarPolygonIcon,X.toolBarPolygonActiveIcon,"polygon",X.toolBarPolygonHoverIcon,X.toolBarPolygonIcon);t+=ag("Rectangle",X.toolBarRectangleIcon,X.toolbarRectangleActiveIcon,"rectangle",X.toolBarRectangleHoverIcon,X.toolBarRectangleIcon);t+=ag("Circle",X.toolbarCircleIcon,X.toolbarCircleActiveIcon,"circle",X.toolbarCircleHoverIcon,X.toolbarCircleIcon);t+=ag("PushPin",X.toolBarPushPinIcon,X.toolBarPushPinActiveIcon,"pushpin",X.toolBarPushPinHoverIcon,X.toolBarPushPinIcon);ah.innerHTML=t;v.parentNode.appendChild(ah);ai(".BM_Module_DragHandle","{ cursor:pointer; }");function ai(aj,an){if(!document.styleSheets){return}if(document.getElementsByTagName("head").length==0){return}var am;var ak;if(document.styleSheets.length>0){for(i=0;i<document.styleSheets.length;i++){if(document.styleSheets[i].disabled){continue}var ap=document.styleSheets[i].media;var al=document.styleSheets[i].href;ak=typeof ap;if(ak=="string"){if(ap==""||(ap.indexOf("screen")!=-1)){styleSheet=document.styleSheets[i]}}else{if(ak=="object"&&al!=null){if(ap.mediaText==""||(ap.mediaText.indexOf("screen")!=-1)){styleSheet=document.styleSheets[i]}}}if(typeof styleSheet!="undefined"){break}}}if(typeof styleSheet=="undefined"){var ao=document.createElement("style");ao.type="text/css";document.getElementsByTagName("head")[0].appendChild(ao);for(i=0;i<document.styleSheets.length;i++){if(document.styleSheets[i].disabled){continue}styleSheet=document.styleSheets[i]}var ap=styleSheet.media;ak=typeof ap}if(ak=="string"){for(i=0;i<styleSheet.rules.length;i++){if(styleSheet.rules[i].selectorText.toLowerCase()==aj.toLowerCase()){styleSheet.rules[i].style.cssText=an;return}}styleSheet.addRule(aj,an)}else{if(ak=="object"){for(i=0;i<styleSheet.cssRules.length;i++){if(styleSheet.cssRules[i].selectorText.toLowerCase()==aj.toLowerCase()){styleSheet.cssRules[i].style.cssText=an;return}}styleSheet.insertRule(aj+"{"+an+"}",0)}}}})();function W(){if(X.targetLayer.toString()!="[EntityCollection]"){throw"Module can only be used to add shapes to an entity collection."}L=f.Events.addHandler(G,"dblclick",l);N=f.Events.addHandler(G,"click",A);u=f.Events.addHandler(G,"keypress",a);H("crosshair");Y=[new f.Location(0,0),new f.Location(0,0)];x=new f.Polyline(Y,{strokeColor:X.maskStrokeColor,strokeThickness:X.maskStrokeThickness,strokeDashArray:X.maskStrokeDashArray});aa=[];q=true}function J(){if(U.toString()!="[Polyline]"&&U.toString()!="[Polygon]"&&U.toString()!="[AdvancedShapes.Polygon]"){throw"Module can only be used for shapes that are polylines or polygons"}O=[];O=U.getLocations();if(d!=null){E.entities.remove(d);d=null}d=new f.EntityCollection();var ah={fillColor:X.shapeMaskFillColor,strokeColor:X.shapeMaskStrokeColor,strokeThickness:X.shapeMaskStrokeThickness,strokeDashArray:X.shapeMaskStrokeDashArray};switch(U.toString()){case"[Polyline]":af=new f.Polyline(O,ah);break;case"[Polygon]":case"[AdvancedShapes.Polygon]":af=new f.Polygon(O,ah);break}var ai=1;if(U.toString()=="[Polygon]"||U.toString()=="[AdvancedShapes.Polygon]"){ai=2}ah={draggable:true,icon:X.dragHandleImage,height:X.dragHandleImageHeight,width:X.dragHandleImageWidth,anchor:X.dragHandleImageAnchor,typeName:"BM_Module_DragHandle"};switch(j.toLowerCase()){case"polyline":case"polygon":case"rectangle":for(i=0;i<=(O.length-ai);i++){var ag=new f.Pushpin(O[i],ah);V(ag)}break;case"circle":var ag=new f.Pushpin(O[26],ah);V(ag);break}d.push(af);E.entities.push(d);u=f.Events.addHandler(G,"keypress",c);v.onkeyup=c}function V(ag){f.Events.addHandler(ag,"dragstart",b);f.Events.addHandler(ag,"drag",B);f.Events.addHandler(ag,"dragend",K);f.Events.addHandler(ag,"mouseover",Z);f.Events.addHandler(ag,"mouseout",ad);d.push(ag)}function A(ai){M=G.tryPixelToLocation(new f.Point(ai.getX(),ai.getY()));aa.push(M);Y[0]=M;switch(X.shapeType.toLowerCase()){case"pushpin":var ag=new f.Pushpin(M,{draggable:false});X.targetLayer.push(ag);ag.shapeType="pushpin";h.edit(ag);if(X.toolBarPushPinMultiple){H("crosshair")}else{T()}break;case"polygon":case"polyline":case"rectangle":case"circle":switch(aa.length){case 1:Y[1]=M;X.targetLayer.push(x);ae=f.Events.addHandler(G,"mousemove",o);break;case 2:var ah={strokeColor:X.shapeStrokeColor,strokeThickness:X.shapeStrokeThickness,fillColor:X.shapeFillColor};switch(X.shapeType.toLowerCase()){case"polyline":w=new f.Polyline(aa,ah);w.shapeType=X.shapeType;X.targetLayer.push(w);break;case"polygon":w=new f.Polygon(aa,ah);w.shapeType=X.shapeType;X.targetLayer.push(w);break;case"rectangle":case"circle":aa=Y;aa.shift();w=new f.Polygon(aa,ah);w.shapeType=X.shapeType;X.targetLayer.push(w);T();break;default:throw'Shape type must be "polygon" or "polyline".'}break;default:x.setLocations(Y);w.setLocations(aa);break}break}ai.handled=true}function o(ag){H("crosshair");_tempLocation=G.tryPixelToLocation(new f.Point(ag.getX(),ag.getY()));switch(X.shapeType.toLowerCase()){case"rectangle":if(Y.length==2){Y.push(_tempLocation);Y.push(_tempLocation);Y.push(Y[0])}Y[2]=_tempLocation;Y[1]=new f.Location(Y[0].latitude,Y[2].longitude);Y[3]=new f.Location(Y[2].latitude,Y[0].longitude);break;case"circle":distance=C(aa[0],_tempLocation);Y=n(aa[0].latitude,aa[0].longitude,distance);break;default:Y[1]=_tempLocation;break}x.setLocations(Y);ag.handled=true}function H(ag){v.style.cursor=ag}function Z(ag){ag.target.setOptions({icon:X.dragHandleImageActive})}function ad(ag){ag.target.setOptions({icon:X.dragHandleImage})}function b(ah){var ag=ah.entity.getLocation();for(i=0;i<=(O.length-1);i++){if(ag==O[i]){P=i;break}}switch(j.toLowerCase()){case"circle":locs=U.getLocations();S=g(locs[17],locs[35]);break;case"rectangle":if(O.length==4){O.push(aa[0])}switch(P){case 0:y=1;k=2;m=3;break;case 1:y=2;k=3;m=0;break;case 2:y=1;k=0;m=3;break;case 3:y=2;k=1;m=0;break}break;default:break}}function B(ag){var ah=ag.entity.getLocation();switch(j.toLowerCase()){case"circle":O=n(S.latitude,S.longitude,C(S,ah));af.setLocations(O);break;case"polyline":case"polygon":O[P]=ah;if(P==0&&(U.toString()=="[Polygon]"||U.toString()=="[AdvancedShapes.Polygon]")){O[O.length-1]=ah}af.setLocations(O);break;case"rectangle":O[P]=ah;O[y]=new f.Location(O[k].latitude,O[P].longitude);O[m]=new f.Location(O[P].latitude,O[k].longitude);O[O.length-1]=O[0];af.setLocations(O);d.get(y).setLocation(O[y]);d.get(k).setLocation(O[k]);d.get(m).setLocation(O[m]);break;default:break}}function K(ag){U.setLocations(O);z(U,O)}function I(ag){if(ag.target!=null){z(ag.target,[ag.target.getLocation()])}}function a(ag){if(p(ag)=="27"){T()}ag.handled=true}function c(ag){if(p(ag)=="27"){r()}else{if(p(ag)=="46"){X.targetLayer.remove(U);O=U.points=null;if(U&&U.id!=null){Q[U.id].points=null}r()}}if(ag){ag.handled=true}}function p(ag){if(window.event){return window.event.keyCode}else{if(ag.keyCode){return ag.keyCode}else{if(ag.which){return ag.which}}}}function l(ag){T();ag.handled=true}function T(){if((w&&w.toString()=="[Polygon]")||(w&&w.toString()=="[AdvancedShapes.Polygon]")||(U&&U.toString()=="[Polygon]")||(U&&U.toString()=="[AdvancedShapes.Polygon]")){if(aa[aa.length-1].toString()==aa[aa.length-2].toString()){aa.pop()}aa.push(aa[0]);w.setLocations(aa)}if(w){z(w,aa)}f.Events.addHandler(w,"click",function(ag){h.edit(ag.target)});X.targetLayer.remove(x);w=null;H("url("+X.shapeMouseCursor+")");f.Events.removeHandler(N);f.Events.removeHandler(ae);f.Events.removeHandler(u);f.Events.removeHandler(L);document.getElementById(e+"_PolylineButton").style.backgroundImage="url("+X.toolBarPolylineIcon+")";document.getElementById(e+"_PolygonButton").style.backgroundImage="url("+X.toolBarPolygonIcon+")";document.getElementById(e+"_RectangleButton").style.backgroundImage="url("+X.toolBarRectangleIcon+")";document.getElementById(e+"_CircleButton").style.backgroundImage="url("+X.toolbarCircleIcon+")";document.getElementById(e+"_PushPinButton").style.backgroundImage="url("+X.toolBarPushPinIcon+")";q=false}function r(){if(U&&X.shapeChangedCallback){X.shapeChangedCallback(Q)}f.Events.removeHandler(u);v.onkeyup=null;E.entities.remove(d);d=null;U=null}function ab(ag){for(optionName in ag){X[optionName]=ag[optionName]}}function C(ap,ao){var ai=ap.latitude,al=ap.longitude,ah=ao.latitude,ak=ao.longitude;var aj=6371/1.609344;var am=(ah-ai).toRad(),ag=(ak-al).toRad();ai=ai.toRad(),ah=ah.toRad();var an=Math.sin(am/2)*Math.sin(am/2)+Math.cos(ai)*Math.cos(ah)*Math.sin(ag/2)*Math.sin(ag/2);return aj*2*Math.atan2(Math.sqrt(an),Math.sqrt(1-an))}function g(ai,aj){lat1=ai.latitude.toRad();lon1=ai.longitude.toRad();lat2=aj.latitude.toRad();var ah=(aj.longitude-ai.longitude).toRad();var ag=Math.cos(lat2)*Math.cos(ah),ak=Math.cos(lat2)*Math.sin(ah);lat3=Math.atan2(Math.sin(lat1)+Math.sin(lat2),Math.sqrt((Math.cos(lat1)+ag)*(Math.cos(lat1)+ag)+ak*ak));lon3=lon1+Math.atan2(ak,Math.cos(lat1)+ag);lon3=(lon3+3*Math.PI)%(2*Math.PI)-Math.PI;return new f.Location(lat3.toDeg(),lon3.toDeg())}function n(ah,ai,an){var al=[],ak=ah.toRad(),am=ai.toRad(),ao=an/3956;for(var aq=0;aq<=360;aq+=10){var aj=(aq/90)*Math.PI/2,ap=Math.asin(Math.sin(ak)*Math.cos(ao)+Math.cos(ak)*Math.sin(ao)*Math.cos(aj)),ag;ap=ap.toDeg();if(Math.cos(ak)==0){ag=ai}else{ag=((am-Math.asin(Math.sin(aj)*Math.sin(ao)/Math.cos(ak))+Math.PI)%(2*Math.PI))-Math.PI}ag=ag.toDeg();al.push(new f.Location(ap,ag))}return al}this.dispose=function(){T()};this.version=function(){return s};this.show=function(){document.getElementById(e).style.visibility="visible"};this.hide=function(){document.getElementById(e).style.visibility="hidden"};this.setOptions=function(ag){ab(ag)};draw=function(ag){if(q){T();changeToolBarBackground(R,ac)}r();ab(ag);W()};this.edit=function(ag){if(ag.shapeType!=null){if(ag.shapeType=="pushpin"){E.entities.remove(d);U=ag;z(ag,[ag.getLocation()]);f.Events.addHandler(ag,"dragend",I);u=f.Events.addHandler(G,"keypress",c);v.onkeyup=c}else{U=ag;j=ag.shapeType;J()}}};this.reset=function(ag){if(ag){Q=ag}};changeToolBarBackground=function(ag,ah){if(!q&&ah!=null){ag.style.backgroundImage="url("+ah+")"}};toolBarClick=function(ah,ai,ag){r();if((ag&&ag.shapeType=="none")||q&&(ah==R)){T()}else{if(ag!=null){R=ah;ac=ai;changeToolBarBackground(R,ac);draw(ag)}}};function z(ah,ag){if(ah.id==null){ah.id=Q.length}ah.points=ag;if(X.shapeChangedCallback){Q[ah.id]=ah;X.shapeChangedCallback(Q)}}};Number.prototype.toRad=function(){return this*Math.PI/180};Number.prototype.toDeg=function(){return this*180/Math.PI};Microsoft.Maps.moduleLoaded("ShapeToolboxModule");