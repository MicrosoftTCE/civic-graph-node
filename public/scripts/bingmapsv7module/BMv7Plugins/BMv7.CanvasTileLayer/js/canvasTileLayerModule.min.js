var CanvasTileLayer=function(e,o){var g=e;var k=j();var b;var d;var n={drawTile:function(p,q){},opacity:1,debugMode:false,cacheTiles:false,cacheTimeout:60};function l(){m(o);var p=new Microsoft.Maps.TileSource({uriConstructor:h});b=new Microsoft.Maps.TileLayer({mercator:p,opacity:n.opacity});g.entities.push(b);if(n.cacheTiles){d=new Cache()}}function j(){var p=document.createElement("canvas");p.id="canvas";p.width=256;p.height=256;return p}function h(p){var u=p.levelOfDetail+"_"+p.x+"_"+p.y;if(n.cacheTiles){var t=d.getItem(u);if(t!=undefined){return t}}var s={x:p.x,y:p.y,z:p.levelOfDetail,pixelCoordinates:c(p),getLocationPixelOffset:function(z){var A=a(z,this.z);var w=(A.x-this.pixelCoordinates.x)|0;var B=(A.y-this.pixelCoordinates.y)|0;return{x:w,y:B}},metersPerPixel:(2*Math.PI*6378137)/(256<<p.levelOfDetail)};var r=k.getContext("2d");var v=new Date().getTime();r.clearRect(0,0,256,256);r.save();n.drawTile(r,s);r.restore();var q=new Date().getTime();if(n.debugMode){f(r,s,q-v)}var t=k.toDataURL();if(n.cacheTiles){d.setItem(u,t,{expirationAbsolute:null,expirationSliding:n.cacheTimeout,priority:CachePriority.NORMAL})}return t}function f(s,u,p){var r="z:"+u.z+"  x:"+u.x+"  y:"+u.y+"";var t="Created at: "+i()+"";var q="Time to draw: "+p.toString();s.shadowColor="black";s.shadowBlur=0;s.shadowOffsetX=0;s.shadowOffsetY=0;s.fillStyle="rgba(255, 255, 255, 0.7)";s.fillRect(5,5,130,50);s.font="bold 12px Arial";s.fillStyle="black";s.textAlign="left";s.textBaseline="middle";s.fillText(r,10,15);s.fillText(t,10,30);s.fillText(q,10,45);s.strokeRect(0,0,256,266)}function c(p){var r=p.x*256;var q=p.y*256;return{x:r,y:q}}function a(q,p){var t=Math.sin(q.latitude*Math.PI/180);var r=(0.5-Math.log((1+t)/(1-t))/(Math.PI*4))*256*Math.pow(2,p);var s=((q.longitude+180)/360)*256*Math.pow(2,p);return{x:(0.5+s)|0,y:(0.5+r)|0}}function i(){var q=new Date(),t=q.getHours(),p=q.getMinutes(),r=q.getSeconds();if(t<10){t="0"+t}if(p<10){p="0"+p}if(r<10){r="0"+r}return""+t+":"+p+":"+r}function m(p){for(attrname in p){n[attrname]=p[attrname]}}this.hide=function(){b.setOptions({visible:false})};this.show=function(){b.setOptions({visible:true})};this.setOpacity=function(p){b.setOptions({opacity:p})};this.remove=function(){g.entities.remove(b)};l()};Microsoft.Maps.moduleLoaded("CanvasTileLayerModule");