var RouteServiceHelper=new function(){function j(a,b){a[0]=Math.min(a[0],b[0]);a[1]=Math.min(a[1],b[1]);a[2]=Math.max(a[2],b[2]);a[3]=Math.max(a[3],b[3]);return a}function i(){var a=d[0];if(a&&a.statusCode==200&&a.resourceSets&&a.resourceSets.length>0&&a.resourceSets[0].resources&&a.resourceSets[0].resources.length>0){var b=a.resourceSets[0].resources[0];for(var c=1;c<d.length;c++){if(d[c]&&d[c].statusCode==200&&d[c].resourceSets&&d[c].resourceSets.length>0&&d[c].resourceSets[0].resources&&d[c].resourceSets[0].resources.length>0){var e=d[c].resourceSets[0].resources[0];b.travelDistance+=e.travelDistance;b.travelDuration+=e.travelDuration;b.bbox=j(b.bbox,e.bbox);b.routeLegs=b.routeLegs.concat(e.routeLegs);if(b.routePath==null&&e.routePath!=null){b.routePath={line:{type:"LineString",coordinates:[]}}}if(e.routePath!=null){b.routePath.line.coordinates=b.routePath.line.coordinates.concat(e.routePath.line.coordinates)}}else{if(d[c]&&d[c].errorDetails){throw d[c].errorDetails}else{throw"Unable to route between locations."}}}a.resourceSets[0].resources[0]=b}return a}function h(a){if(a==null)return true;return typeof a=="string"&&a.replace(/\s/g,"").length<1}function g(a,c,d,e){var g=["http://dev.virtualearth.net/REST/v1/Routes/"];if(d.travelMode.toLowerCase()=="walking"){g.push("Walking")}else{g.push("Driving")}g.push("?key=",e);g.push("&jsonp=RouteServiceHelper.__InternalCallback&jsonso=",c);for(var i=0;i<a.length;i++){g.push("&wp.",i,"=");if(typeof a[i]=="string"){g.push(a[i])}else if(a[i].latitude!=null&&a[i].longitude!=null){g.push(a[i].latitude,",",a[i].longitude)}else{f=true;throw"Invalid waypoint encountered."}}g.push(h(d.avoid)?"":"&avoid="+d.avoid);g.push(b.distanceBeforeFirstTurn==null&&d.distanceBeforeFirstTurn>0?"":"&dbft="+d.distanceBeforeFirstTurn);g.push(h(d.distanceUnit)?"":"&du="+d.distanceUnit);g.push(b.heading==null?"":"&hd="+d.heading);g.push(h(d.optimize)?"":"&optmz="+d.optimize);g.push(h(d.routePathOutput)?"":"&rpo="+d.routePathOutput);g.push(h(d.tolerances)?"":"&tl="+d.tolerances);g.push(h(d.culture)?"":"&c="+d.culture);var j=document.createElement("script");j.setAttribute("type","text/javascript");j.setAttribute("src",g.join(""));document.body.appendChild(j)}var a=false,b={avoid:null,distanceBeforeFirstTurn:0,heading:null,optimize:"time",routePathOutput:"None",travelMode:"Driving",distanceUnit:"km",culture:null,batchSize:15},c,d,e,f=false;this.GetRoute=function(h,j,k,l){if(l!=null){if(a){throw"Already processing a route."}try{var m=b;for(attrname in k){m[attrname]=k[attrname]}if(m.batchSize>24||m.batchSize<0){m.batchSize=24}c=function(b,c){d[parseInt(c)]=b;e++;if(b==null){}else if(b.statusCode!=200){f=true}if(e==d.length){a=false;l(i())}};a=true;d=[];if(h==null||h.length<2){throw"Invalid waypoint array."}var n=Math.ceil(h.length/m.batchSize);e=0;d=[n];var o,p;for(var q=0;q<n;q++){o=q*m.batchSize;p=o+m.batchSize+1;if(p>h.length){p=h.length}g(h.slice(o,p),q,m,j)}}catch(r){l({statusCode:400,errorDetails:r})}}else{c=null}};this.IsProcessing=function(){return a};this.__InternalCallback=function(a,b){if(c!=null){c(a,b)}}};Microsoft.Maps.moduleLoaded("RouteServiceHelper")