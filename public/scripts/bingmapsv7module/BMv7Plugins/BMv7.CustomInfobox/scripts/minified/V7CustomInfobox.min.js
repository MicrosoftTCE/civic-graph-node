var CustomInfobox=function(map,options){var _map=map,_content,_anchor,_infoboxContainerId,_handlerId;var _options={arrowColor:"#fff",arrowLength:20,arrowWidth:30,borderColor:"#000",color:"#fff",minHeight:50,minWidth:100,offset:{x:0,y:0},orientation:0,showArrow:true,showCloseButton:true,tether:false};function _init(){_infoboxContainerId=map.getRootElement().parentNode.id+"_infobox";$("body").append("<div id='"+_infoboxContainerId+"' style='position:absolute;z-index:10000;display:none;'></div>");_enableTethering(_options.tether);_setOptions(options)}function _createArrow(direction){var html=["<div id='",_infoboxContainerId,"_arrow' style='position:relative;float:left;width:0;height:0;line-height:0;border-style:solid;"];var w=_options.arrowWidth*0.5;switch(direction){case 0:html.push("border-width:0 ",w,"px ",_options.arrowLength,"px ",w,"px;");html.push("border-color:transparent transparent ",_options.arrowColor," transparent;");break;case 1:html.push("border-width:",w,"px 0 ",w,"px ",_options.arrowLength,"px;");html.push("border-color:transparent transparent transparent ",_options.arrowColor,";");break;case 2:html.push("border-width:",_options.arrowLength,"px ",w,"px 0 ",w,"px;");html.push("border-color:",_options.arrowColor," transparent transparent transparent;");break;case 3:html.push("border-width:",w,"px ",_options.arrowLength,"px ",w,"px 0;");html.push("border-color:transparent ",_options.arrowColor," transparent transparent;");break}html.push("'></div>");return html.join("")}function _enableTethering(tether){if(_handlerId!=null){Microsoft.Maps.Events.removeHandler(_handlerId)}if(tether){_handlerId=Microsoft.Maps.Events.addThrottledHandler(_map,"viewchange",_render,40)}else{_handlerId=Microsoft.Maps.Events.addHandler(_map,"viewchangestart",_hide)}}function _hide(){_anchor=null;_content=null;_render()}function _render(){var container=$("#"+_infoboxContainerId);if(container!=null&&_anchor!=null&&_content!=null){if(!_map.getBounds().contains(_anchor)){container.css("display","none")}else{container.css("display","");var pinPixel=_map.tryLocationToPixel(_anchor,Microsoft.Maps.PixelReference.control),screenX=_map.getPageX()+pinPixel.x,screenY=_map.getPageY()+pinPixel.y;var key=(_map.getHeight()*0.5<pinPixel.y)?2:0;key+=(_map.getWidth()*0.5<pinPixel.x)?1:0;var contents=["<div id='",_infoboxContainerId,"_content' style='position:relative;float:left;border:1px solid ",_options.borderColor,";background-color:",_options.color,";min-width:",_options.minWidth,"px;min-height:",_options.minHeight,"px;'>",_content,"</div>"];var arrowX=0,arrowY=0,html;if(_options.showArrow){if(_options.orientation){arrowX=_options.arrowWidth;arrowY=_options.arrowLength;if(key>1){html=contents.join("")+_createArrow(2)}else{html=_createArrow(0)+contents.join("")}}else{arrowX=_options.arrowLength;arrowY=_options.arrowWidth;if(key%2){html=contents.join("")+_createArrow(1)}else{html=_createArrow(3)+contents.join("")}}}else{html=contents.join("")}container.html(html);var contentContainer=$("#"+_infoboxContainerId+"_content");if(_options.showCloseButton){contentContainer.append("<span id='"+_infoboxContainerId+"_closeBtn' href='javascript:void()' style='position:absolute;right:5px;top:2px;cursor:pointer;font:bold 18px Arial;line-height:12px;'>x</span>");$("#"+_infoboxContainerId+"_closeBtn").click(function(){_hide()})}var contentX=contentContainer.outerWidth(),contentY=contentContainer.outerHeight();var w=0,h=0,arrowOffsetTop=0,arrowOffsetLeft=0;if(_options.orientation){w=contentX;h=contentY+arrowY;if(key%2){arrowOffsetLeft=w-_options.arrowWidth;screenX+=_options.offset.x-w+_options.arrowWidth*0.5}else{screenX+=_options.offset.x-_options.arrowWidth*0.5}if(key>1){screenY-=h+_options.offset.y}else{screenY-=_options.offset.y}}else{w=arrowX+contentX+2;h=Math.max(contentY,arrowY);if(key%2){screenX+=_options.offset.x-w}else{screenX+=_options.offset.x}if(key>1){arrowOffsetTop=h-_options.arrowWidth;screenY-=h-_options.arrowWidth*0.5+_options.offset.y}else{screenY-=(_options.arrowWidth*0.5+_options.offset.y)}}if(_options.showArrow){var arrow=$("#"+_infoboxContainerId+"_arrow");arrow.css({"margin-left":Math.ceil(arrowOffsetLeft)+"px","margin-top":Math.ceil(arrowOffsetTop)+"px"})}container.css({width:Math.ceil(w)+"px",height:Math.ceil(h)+"px",top:screenY,left:screenX})}}else{if(container!=null){container.html("");container.css("display","none")}}}function _setOptions(options){var tetherVal=_options.tether;for(attrname in options){_options[attrname]=options[attrname]}if(tetherVal!=_options.tether){_enableTethering(_options.tether)}_render()}this.hide=function(){_hide()};this.show=function(latlong,content){_anchor=latlong;_content=content;_render()};this.getOptions=function(){return _options};this.setOptions=function(options){_setOptions(options)};_init()};Microsoft.Maps.moduleLoaded("CustomInfoboxModule");