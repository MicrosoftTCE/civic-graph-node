var PointBasedClusteredEntityCollection=function(a,q){var e=a,l,i=1,d=0,c=[],n=[21],o=21;var g=(Math.PI/180),f=1/(4*Math.PI);var p={clusterRadius:30,singlePinCallback:function(s,r){return new Microsoft.Maps.Pushpin(r.center)},clusteredPinCallback:function(r){var s=new Microsoft.Maps.Pushpin(r.center,{text:"+"});s.description=r.dataIndices.length+" locations<br/>Zoom in for more details.";return s},callback:null};function k(){l=new Microsoft.Maps.EntityCollection();e.entities.push(l);for(var r=0;r<21;r++){n[r]=null}j(q);Microsoft.Maps.Events.addThrottledHandler(e,"viewchangeend",function(){var s=e.getZoom();d=256*Math.pow(2,s);if(s!=i){i=s;if(i<=o){m()}}b()},500)}function m(){l.clear();var v=n[i];if(v==null||v.length==0){v=[],clusterCount=0;if(c!=null){var u=c.length-1,s,r,t;if(u>=0){do{r=h(c[u]._LatLong);s=clusterCount-1;if(s>=0){do{if(r.y>=v[s].top&&r.y<=v[s].bottom&&((v[s].left<=v[s].right&&r.x>=v[s].left&&r.x<=v[s].right)||(v[s].left>=v[s].right&&(r.x>=v[s].left||r.x<=v[s].right)))){v[s].dataIndices.push(u);c[u]._clusterIndex=s;break}}while(s--);if(s==-1){t={index:clusterCount,dataIndices:[],center:c[u]._LatLong,left:r.x-p.clusterRadius,right:r.x+p.clusterRadius,top:r.y-p.clusterRadius,bottom:r.y+p.clusterRadius,zoom:i};t.dataIndices.push(u);if(t.left<0){t.left+=d}if(t.right>d){t.right-=d}c[u]._clusterIndex=clusterCount;v.push(t);clusterCount++}}else{t={index:clusterCount,dataIndices:[],center:c[u]._LatLong,left:r.x-p.clusterRadius,right:r.x+p.clusterRadius,top:r.y-p.clusterRadius,bottom:r.y+p.clusterRadius,zoom:i};t.dataIndices.push(u);if(t.left<0){t.left+=d}if(t.right>d){t.right-=d}c[u]._clusterIndex=clusterCount;v.push(t);clusterCount++}}while(u--)}}}n[i]=v}function b(){l.clear();var v=e.getBounds();if(i<=o){var u=n[i];if(u!=null&&u.length>0){var t=u.length-1,r,w;if(t>=0){do{w=u[t];if(v.contains(u[t].center)){if(w.dataIndices.length==1){r=p.singlePinCallback(c[w.dataIndices[0]],w)}else{r=p.clusteredPinCallback(w)}r._clusterInfo=w;l.push(r)}}while(t--)}}}else{var t=c.length-1,s,r;if(t>=0){do{s={index:t,dataIndices:[],center:c[t]._LatLong,left:null,right:null,top:null,bottom:null,zoom:i};s.dataIndices.push(t);if(v.contains(c[t]._LatLong)){r=p.singlePinCallback(c[t],s);r._clusterInfo=s;l.push(r)}}while(t--)}}if(p.callback){p.callback()}}function h(s){var t=Math.sin(s.latitude*g);if(t==1||t==-1){t+=1e-10}var r=((s.longitude+180)/360)*d;var u=(0.5-Math.log((1+t)/(1-t))*f)*d;return{x:Math.round(r),y:Math.round(u)}}function j(r){for(var s=0;s<21;s++){n[s]=null}for(attrname in r){p[attrname]=r[attrname]}m();b()}this.GetLayer=function(){return l};this.GetOptions=function(){return p};this.SetOptions=function(r){j(r)};this.BringLayerToFront=function(){var s=e.entities.getLength()-1,r;if(s>=0){do{r=e.entities.get(s);if(r.clear!=null){r.setOptions({zIndex:0})}}while(s--);s=e.entities.indexOf(l);r=e.entities.get(s);r.setOptions({zIndex:1})}};this.SetData=function(s){if(s!=null&&s.length>0){c=s;var r=c.length-1;if(r>=0){do{c[r]._LatLong=new Microsoft.Maps.Location(c[r].latitude,c[r].longitude)}while(r--)}m();b()}else{c=[];l.clear()}};this.GetData=function(){return c};this.GetDisplayedData=function(){var r=[];var u=l.getLength()-1;if(u>=0){do{var t=l.get(u);if(t._clusterInfo!=null&&t._clusterInfo.dataIndices.length>0){for(var s=0;s<t._clusterInfo.dataIndices.length;s++){r.push(c[t._clusterInfo.dataIndices[s]])}}}while(u--)}return r};this.GetDataByIndex=function(r){if(r<c.length){return c[r]}return null};this.GetDataByClusterIndex=function(t){var r=[],u=n[i];if(u!=null&&u.length>t&&u[t]!=null&&u[t].dataIndices!=null&&u[t].dataIndices.length>0){for(var s=0;s<u[t].dataIndices.length;s++){r.push(c[u[t].dataIndices[s]])}}return r};this.GetPinByClusterIndex=function(s){var t=l.getLength()-1;if(t>=0){do{var r=l.get(t);if(r._clusterInfo.index==s){return r}}while(t--)}return null};k()};Microsoft.Maps.moduleLoaded("PointBasedClusteringModule");