var ClusterPlacementTypes={MeanAverage:0,GridCenter:1,FirstLocation:2};var ClusteredEntityCollection=function(map,options){var _map=map,_layer,_data=[],_numXCells,_numYCells;var _options={gridSize:45,clusterPlacementType:ClusterPlacementTypes.MeanAverage,layerOffset:new Microsoft.Maps.Point(0,0),clusteringEnabled:true,singlePinCallback:function(data){return new Microsoft.Maps.Pushpin(data._LatLong)},clusteredPinCallback:function(data){var pin=new Microsoft.Maps.Pushpin(data._LatLong,{text:"+"});pin.description=cluster.length+" locations<br/>Zoom in for more details.";return pin},callback:null};function _init(){_layer=new Microsoft.Maps.EntityCollection();_map.entities.push(_layer);setOptions(options);Microsoft.Maps.Events.addHandler(_map,"viewchangeend",cluster)}function calculateClusteredLatlong(cluster,key){switch(_options.clusterPlacementType){case ClusterPlacementTypes.MeanAverage:var lat=0,lon=0;var i=cluster.length-1;if(i>=0){do{lat+=cluster[i]._LatLong.latitude;lon+=cluster[i]._LatLong.longitude}while(i--)}return new Microsoft.Maps.Location(lat/cluster.length,lon/cluster.length);case ClusterPlacementTypes.GridCenter:var x=((key%_numXCells)+0.5)*_options.gridSize+_options.layerOffset.x;var y=(Math.floor(key/_numXCells)+0.5)*_options.gridSize+_options.layerOffset.y;return _map.tryPixelToLocation(new Microsoft.Maps.Point(x,y),Microsoft.Maps.PixelReference.control);default:case ClusterPlacementTypes.FirstLocation:return cluster[0]._LatLong}}function cluster(){_layer.clear();if(_data!=null){var mapWidth=_map.getWidth();var mapHeight=_map.getHeight();_numXCells=parseInt(Math.ceil(mapWidth/_options.gridSize));_numYCells=parseInt(Math.ceil(mapHeight/_options.gridSize));var i=_data.length-1,pixel,k,j,key,pin;if(_options.clusteringEnabled){var gridCells=new Array(_numXCells*_numYCells);if(i>=0){do{pixel=_map.tryLocationToPixel(_data[i]._LatLong,Microsoft.Maps.PixelReference.control);if(pixel!=null&&pixel.x<=mapWidth&&pixel.y<=mapHeight&&pixel.x>=0&&pixel.y>=0){k=Math.floor(pixel.x/_options.gridSize);j=Math.floor(pixel.y/_options.gridSize);key=k+j*_numXCells;if(gridCells[key]==null){gridCells[key]=[]}gridCells[key].push(_data[i]);_data[i].GridKey=key}else{_data[i].GridKey=-1}}while(i--)}i=gridCells.length-1;if(i>=0){do{if(gridCells[i]!=null){switch(gridCells[i].length){case 1:pin=_options.singlePinCallback(gridCells[i][0]);pin.isClustered=false;break;default:var latlong=calculateClusteredLatlong(gridCells[i],i);pin=_options.clusteredPinCallback(gridCells[i],latlong);pin.isClustered=true;break}pin.GridKey=i;_layer.push(pin)}}while(i--)}}else{if(i>=0){do{pixel=_map.tryLocationToPixel(_data[i]._LatLong,Microsoft.Maps.PixelReference.control);if(pixel!=null&&pixel.x<=mapWidth&&pixel.y<=mapHeight&&pixel.x>=0&&pixel.y>=0){_data[i].GridKey=i;pin=_options.singlePinCallback(_data[i]);pin.GridKey=i;pin.isClustered=false;_layer.push(pin)}else{_data[i].GridKey=-1}}while(i--)}}}if(_options.callback){_options.callback()}}function setOptions(options){for(attrname in options){_options[attrname]=options[attrname]}cluster()}this.GetLayer=function(){return _layer};this.GetOptions=function(){return _options};this.SetOptions=function(options){setOptions(options)};this.BringLayerToFront=function(){var i=_map.entities.getLength()-1,entity;if(i>=0){do{entity=_map.entities.get(i);if(entity.clear!=null){entity.setOptions({zIndex:0})}}while(i--);i=_map.entities.indexOf(_layer);entity=_map.entities.get(i);entity.setOptions({zIndex:1})}};this.SetData=function(data){if(data!=null){_data=data;var i=_data.length-1;if(i>=0){do{_data[i]._LatLong=new Microsoft.Maps.Location(_data[i].Latitude,_data[i].Longitude)}while(i--)}}else{_data=[]}cluster()};this.GetData=function(){return _data};this.GetDisplayedData=function(){var result=[];var i=_data.length-1;if(i>=0){do{if(_data[i].GridKey!=-1){result.push(_data[i])}}while(i--)}return result.reverse()};this.GetDataByGridKey=function(key,isClustered){var result=[];var i=_data.length-1;if(i>=0){if(isClustered){do{if(key==_data[i].GridKey){result.push(_data[i])}}while(i--)}else{do{if(key==_data[i].GridKey){result.push(_data[i]);break}}while(i--)}}return result.reverse()};this.GetPinByGridKey=function(key){var i=_layer.getLength()-1,pin;if(i>=0){do{pin=_layer.get(i);if(pin.GridKey==key){return pin}}while(i--)}return null};_init()};Microsoft.Maps.moduleLoaded("ClientSideClusteringModule");